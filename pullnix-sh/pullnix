NIXOS_CONFIG_DIR=/etc/nixos
LOG_DIR=/var/log/pullnix
PULLNIX_LOG=$LOG_DIR/pullnix.log
GIT_REMOTE=origin
GIT_BRANCH=main

#POLL_TIME=300
POLL_TIME=60


cmd_git=/run/current-system/sw/bin/git
cmd_nixos_rebuild=/run/current-system/sw/bin/nixos-rebuild



# Set up logging files
if ! [ -d $LOG_DIR ]; then
    mkdir $LOG_DIR
fi
if ! [ -f $PULLNIX_LOG ]; then
    touch $PULLNIX_LOG
fi


switch() {
    $cmd_git pull
    $cmd_nixos_rebuild build -p $remote_head -I $NIXOS_CONFIG_DIR/configuration.nix

    if [ $? -eq 0 ]; then
        echo "\`nixos-rebuild switch\` would go here"

        if [ $($cmd_git ls-remote &>> /dev/null; echo $?) -eq 0 ]; then
            echo "git repo connection successful"
        else
            echo "git repo connection failed"
            echo "Switching back"
            echo "\`nixos-rebuild switch --rollback\` would go here"
        fi
    fi
}


cd $NIXOS_CONFIG_DIR

while true; do
    $cmd_git fetch
    local_head=$(git rev-parse $GIT_BRANCH)
    remote_head=$(git rev-parse $GIT_REMOTE/$GIT_BRANCH)

    if [ $local_head != $remote_head ]; then
        echo "Out of sync -- local:${local_head:0:7} => remote:${remote_head:0:7}"
        switch
        echo "----------"
    fi

    sleep $POLL_TIME
done
